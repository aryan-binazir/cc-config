---
name: ticket_analysis
description: Analyze a ticket to find relevant files and assess necessity
argument-hint: "<ticket title and/or description>"
version: "1.0"
---

Analyze a new ticket to provide initial context and critical assessment. Uses sequential sub-agents for thorough research.

## Ticket Information

$ARGUMENTS

If `$ARGUMENTS` is empty, ask the user to provide the ticket title and/or description.

## Output Destination

Results are written to BOTH:
1. Screen (displayed to user)
2. `context/initial_review-{branch}.md` where `{branch}` comes from `git branch --show-current` (with `/` replaced by `-`)

## Workflow

### Phase 1: File Research (Sonnet)

Spawn a sub-agent using the Task tool with these parameters:
- `subagent_type`: `"Explore"`
- `model`: `"sonnet"`
- Thoroughness: `"very thorough"`

**Sub-agent prompt**:

```
## Ticket to Analyze

{paste ticket info from $ARGUMENTS}

## Task

Perform a thorough codebase exploration to identify files and specific line numbers relevant to this ticket. You are helping someone get familiar with the codebase before working on this ticket.

## Requirements

1. Search broadly - consider multiple naming conventions, related concepts, and indirect dependencies
2. Trace the flow: entry points → core logic → data models → tests
3. For each relevant file found, provide:
   - File path and specific line number(s)
   - WHY this file/location matters for understanding or implementing this ticket
   - What concept or component it represents

## Output Format

Return a structured analysis:

### Entry Points
(Where the feature/bug would be triggered or accessed)

### Core Logic
(Main implementation files that would need changes or understanding)

### Data Models / Types
(Relevant data structures, interfaces, schemas)

### Tests
(Existing test files that cover related functionality)

### Configuration / Infrastructure
(Config files, build setup, or infra that might be relevant)

For each item, use format:
- `path/to/file.ext:123-145` - [Why this matters for the ticket]
```

Capture the full output from Phase 1.

### Phase 2: Need Analysis (Sonnet)

Spawn a second sub-agent using the Task tool with:
- `subagent_type`: `"general-purpose"`
- `model`: `"sonnet"`

**Sub-agent prompt**:

```
## Ticket

{paste ticket info from $ARGUMENTS}

## Codebase Research Findings

{paste Phase 1 output here}

## Task

Based on the ticket description and the codebase research above, provide a critical analysis of this ticket's necessity and value.

## Analysis Required

1. **Why We Need This** (or **Why We Might Not**)
   - What problem does this solve?
   - Who benefits and how?
   - What's the cost of NOT doing this?

2. **Alternatives Considered**
   - Are there simpler approaches?
   - Could this be solved differently with existing code?
   - Is this solving the right problem?

3. **Risks & Concerns**
   - What could go wrong?
   - Hidden complexity or scope creep potential?
   - Dependencies or blockers?

4. **Recommendation**
   - Clear verdict: Proceed / Needs refinement / Question the premise
   - If "Proceed": key considerations for implementation
   - If "Needs refinement": what questions need answers first
   - If "Question the premise": what alternative should be explored

Be direct and critical. It's better to challenge a ticket early than waste time on unnecessary work.
```

Capture the full output from Phase 2.

### Phase 3: Compile & Output

Combine both phases into the final report.

**Report Structure**:

```markdown
# Initial Ticket Review

**Ticket**: {ticket title/description summary}
**Branch**: {current branch}
**Date**: {today's date}

---

## Part 1: Relevant Files & Locations

{Phase 1 output}

---

## Part 2: Necessity Analysis

{Phase 2 output}

---

*Generated by `/ticket_analysis`*
```

**Output Actions**:

1. Display the full report to the user
2. Write the report to `context/initial_review-{branch}.md`:
   - Get branch: `git branch --show-current`
   - Replace `/` with `-` in branch name
   - Create `context/` directory if it doesn't exist
   - Write to `context/initial_review-{branch}.md`
3. Confirm: "Report saved to `context/initial_review-{branch}.md`"

## Notes

- Both sub-agents use Sonnet model for cost-effective thorough analysis
- Phase 2 depends on Phase 1 findings, so they must run sequentially
- If either phase fails, report partial results and note what failed
